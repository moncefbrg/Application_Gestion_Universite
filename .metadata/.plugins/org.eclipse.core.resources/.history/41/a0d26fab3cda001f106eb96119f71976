package com.example.demo;

import com.example.demo.entities.Niveau;
import com.example.demo.repositories.INiveau;
import com.example.demo.services.Etudiant.IEtudiantService;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;

import java.io.BufferedReader;
import java.io.File;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.HashMap;
import java.util.Map;

@SpringBootApplication
public class Application1Application {

    public static void main(String[] args) {
        SpringApplication.run(Application1Application.class, args);
    }
    @Bean
    CommandLineRunner basededonnes(INiveau iNiveau) {
        return args -> {
        	Map<Long, Niveau> niveauxMap = lireNiveauxDepuisFichier();

            // Afficher les niveaux chargés (pour vérification)
            niveauxMap.forEach((id, niveau) -> {
                System.out.println("Niveau chargé : " + niveau);
            });

            // Ici, vous pouvez ajouter la logique pour sauvegarder les niveaux dans la base de données
            // Par exemple, en utilisant un repository JPA :
            // niveauRepository.saveAll(niveauxMap.values());
        };
        }
    

    private Map<Long, Niveau> lireNiveauxDepuisFichier() {
        Map<Long, Niveau> niveauxMap = new HashMap<>();

        try (InputStream inputStream = getClass().getClassLoader().getResourceAsStream("niveaux.csv");
             BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream))) {

            String ligne;
            boolean premiereLigne = true;
            while ((ligne = reader.readLine()) != null) {
                if (premiereLigne) {
                    // Ignorer l'en-tête du fichier CSV
                    premiereLigne = false;
                    continue;
                }

                // Diviser la ligne en colonnes
                String[] colonnes = ligne.split(",");
                if (colonnes.length < 4) { // Vérifier qu'il y a au moins 4 colonnes
                    System.err.println("Ligne mal formatée : " + ligne);
                    continue;
                }

                try {
                    // Extraire les données de la ligne
                    Long id = Long.parseLong(colonnes[0].trim());
                    String alias = colonnes[1].trim();
                    String nom = colonnes[2].trim();
                    String niveauSuivantIdStr = colonnes[3].trim();

                    // Créer un objet Niveau
                    Niveau niveau = new Niveau();
                    niveau.setId(id);
                    niveau.setAlias(alias);
                    niveau.setNom(nom);

                    // Ajouter le niveau à la Map
                    niveauxMap.put(id, niveau);

                    // Lier le niveau à son niveau suivant (si niveauSuivantId est présent)
                    if (!niveauSuivantIdStr.isEmpty()) {
                        Long niveauSuivantId = Long.parseLong(niveauSuivantIdStr);
                        niveau.setNiveauSuivant(niveau);
                    }
                } catch (NumberFormatException e) {
                    System.err.println("Erreur de parsing dans la ligne : " + ligne);
                    e.printStackTrace();
                }
            }

            // Résoudre les références entre les niveaux
            for (Niveau niveau : niveauxMap.values()) {
                if (niveau.getNiveauSuivant() != null) {
                    Niveau niveauSuivant = niveauxMap.get(niveau.getNiveauSuivant());
                    if (niveauSuivant != null) {
                        niveau.setNiveauSuivant(niveauSuivant);
                    } else {
                        System.err.println("Avertissement : Le niveau suivant avec l'ID " + niveau.getNiveauSuivant() + " n'existe pas pour le niveau " + niveau.getId());
                    }
                }
            }

        } catch (Exception e) {
            System.err.println("Erreur lors de la lecture du fichier niveaux.csv : " + e.getMessage());
            e.printStackTrace();
        }

        return niveauxMap;
    }
}
	/*
	 * @Bean CommandLineRunner demo(IEtudiantService etudiantService) { return args
	 * -> { File file = new File("C:\\Users\\MONCEF\\Desktop\\projet.xlsx");
	 * etudiantService.inscrire(file); }; }
	 */
